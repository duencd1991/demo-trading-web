webpackJsonp([35],{430:function(t,e,r){"use strict";function s(t){var e,r=[];for(e in t)t.hasOwnProperty(e)&&null!=t[e]&&r.push({key:e,pair:encodeURIComponent(e)+"="+encodeURIComponent(t[e])});return r.sort(function(t,e){return t.key>e.key?1:t.key<e.key?-1:0}).map(function(t){return t.pair}).join("&")}function i(t){var e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return void 0!==t&&(e.Authorization="Bearer "+t),e}function o(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}function n(t,e,r,o,n){return void 0===r&&(r=F.Get),x.b(this,void 0,void 0,function(){var a,u,c,l;return x.d(this,function(d){switch(d.label){case 0:a=o?s(o):o,u={method:F[r],headers:i(e)},a&&r!==F.Get&&(u.body=a),d.label=1;case 1:return d.trys.push([1,3,,4]),[4,fetch(t,u)];case 2:if(c=d.sent(),!c.ok)throw Error(c.statusText);return[2,c];case 3:throw l=d.sent(),l.message=h(l),n&&n.logError(l.message),l;case 4:return[2]}})})}function a(t,e,r,s,i){return void 0===r&&(r=F.Get),x.b(this,void 0,void 0,function(){var a,u,c;return x.d(this,function(l){switch(l.label){case 0:return[4,n(t,e,r,s,i)];case 1:return a=l.sent(),[4,a.json()];case 2:if(u=l.sent(),!o(u))throw c=u.errmsg?u.errmsg:z,i&&i.logError(c),Error(c);return[2,u]}})})}function u(t,e,r,s,i){return void 0===r&&(r=F.Get),x.b(this,void 0,void 0,function(){var o;return x.d(this,function(n){switch(n.label){case 0:return[4,a(t,e,r,s,i)];case 1:return o=n.sent(),[2,o.d?o.d:o]}})})}function c(t){return t="/"===t[t.length-1]?t:t+"/"}function l(t,e,r){return x.b(this,void 0,void 0,function(){var s,i;return x.d(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,u(t,void 0,F.Post,{login:e,password:r,locale:window.locale})];case 1:return s=o.sent(),[2,s];case 2:throw i=o.sent();case 3:return[2]}})})}function h(t){var e;return e=t instanceof Error?t.message:"object"==typeof t?JSON.stringify(t):""+t,Object(j.removeTags)(e)}function d(t,e){var r,s;void 0===e&&(e=null),r=null!==e?window.t("This brokerage account is not for trading this market. {break}  Select the account {account} and try again.").format({break:"</br>",account:e}):window.t("This symbol cannot be traded through {brokerTitle}.").format({brokerTitle:t}),s='\n\t\t<p class="tv-text">\n\t\t'+r+"\n\t\t</p>\n\t",Object(M.showNoticeDialog)({title:window.t("Can't place the order"),content:s,width:500,type:"modal",draggable:!1,closeOnOutsideClick:!1,addClass:"tv-text"})}function p(t){return{valid:!0,data:t}}function _(t,e,r,s){return void 0===s&&(s=p),x.b(this,void 0,void 0,function(){var i,o,n,a,u;return x.d(this,function(c){switch(c.label){case 0:i={method:F[e],headers:r},c.label=1;case 1:return c.trys.push([1,4,,5]),[4,fetch(t,i)];case 2:if(o=c.sent(),!o.ok)throw Error(o.statusText);return[4,o.json()];case 3:if(n=c.sent(),a=s(n),!a.valid)throw Error(a.errormsg);return[2,a.data];case 4:throw u=c.sent(),Error(u.message);case 5:return[2]}})})}function f(t){return t.then(function(){})}function y(t){var e=t.checked?t:it
;localStorage.setItem("digital-signature-state",JSON.stringify(e))}function g(){var t=localStorage.getItem("digital-signature-state");return null!==t?JSON.parse(t):it}function m(){var t=g();return{customFields:[{id:"digitalSignature",title:window.t("Digital Signature"),placeHolder:window.t("Enter your personal digital signature"),value:t,customInfo:{checkboxTitle:window.t("Save"),asterix:!0}}]}}function b(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function v(t){return t=t||"market",Z[t]}function P(t){return t=t||2,tt[t]}function w(t){return"sell"===t?-1:1}function k(t){return-1===t?"sell":"buy"}function T(t){return et[t]}function S(){return"?requestId="+Object(Q.randomHashN)(10)}function O(t){var e=Object(N.formatNumber)(t.balance),r=Object(N.formatNumber)(t.unrealizedPl);return[[[e,Object(N.formatNumber)(t.balance+t.unrealizedPl),+r]]]}function q(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function I(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:O(t)}function U(t,e){var r=2!==e.status&&1!==e.status,s=r?e.limitPrice:void 0,i=r?e.stopPrice:void 0;3===e.type?t.stopLoss=i:t.takeProfit=s}function A(t){var e,r,s,i,o=[];for(e=0,r=t;e<r.length;e++)s=r[e],i={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker},o.push(i);return o}function B(t){return t.map(function(t){return{price:t[0],volume:t[1]}})}var x,D,R,C,E,V,N,L,j,M,z,F,Q,W,H,G,J,K,X,Y,Z,tt,et,rt,st,it,ot;Object.defineProperty(e,"__esModule",{value:!0}),x=r(0),D=r(234),r(9),R=[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Type"),className:"",property:"type",formatter:"type"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{label:window.t("Limit Price"),className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:window.t("Stop Price"),className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPrice"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPrice"},{label:window.t("Avg Fill Price"),className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{id:"status",label:window.t("Status"),className:"",property:"status",formatter:"status",supportedStatusFilters:[0]},{label:window.t("Update Time"),className:"",property:"updateTime",formatter:"localDate"},{label:window.t("Order id"),className:"",property:"id"},{label:window.t("Expiry"),className:"tv-data-table__cell--right-align",property:"expiry",formatter:"localDate"},{label:"",
className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}],C=[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Type"),className:"",property:"type",formatter:"type"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{label:window.t("Limit Price"),className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:window.t("Stop Price"),className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPriceForexSup"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPriceForexSup"},{id:"status",label:window.t("Status"),className:"",property:"status",formatter:"status"},{label:window.t("Update Time"),className:"",property:"updateTime",formatter:"localDate"},{label:window.t("Order id"),className:"",property:"id"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}],window.t("Balance"),window.t("Equity",{context:"trading"}),window.t("Total Profit"),E=[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{label:window.t("Avg Fill Price"),className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"formatPrice"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPriceForexSup"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPriceForexSup"},{label:window.t("Profit"),className:"tv-data-table__cell--right-align",property:"unrealizedPl",formatter:"profit",fixedWidth:!0},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"posSettings",notSortable:!0,modificationProperty:"status"}],V=r(6),N=r(82),L=r(388),j=r(410),M=r(237),z=window.t("Failed to fetch"),function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(F||(F={})),Q=r(22),W=r(5),H=r(8),G=r.n(H),J=Object(W.getLogger)("Trading.Requester"),K=function(){function t(t,e,r,s,i){this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._headers=r,this._method=e,this._requestInterval=s,this.update=new G.a,this.statusChanged=new G.a,this._extractResponseData=i}return t.prototype.start=function(){this._status=1,this._errorsCount=0,
this._request()},t.prototype.stop=function(){this._status=0,this._clearResetRequestTimeout()},t.prototype.status=function(){return this._status},t.prototype.changeUrl=function(t){Object(V.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t},t.prototype._request=function(){return x.b(this,void 0,void 0,function(){var t,e,r,s;return x.d(this,function(i){switch(i.label){case 0:if(1!==this._status)return[2];i.label=1;case 1:return i.trys.push([1,3,4,7]),t=this._url,[4,_(this._url,this._method,this._headers,this._extractResponseData)];case 2:return e=i.sent(),this._errorsCount=0,t===this._url&&1===this._status&&(this.update.fire(e,this._snapshot),this._snapshot=!1),[3,7];case 3:return r=i.sent(),s=h(r),J.logError(s+": "+this._url),this._errorsCount++,this._failOnErrorsCount(s),[3,7];case 4:return null===this._requestInterval||1!==this._status?[3,6]:[4,this._makeNextRequest()];case 5:i.sent(),i.label=6;case 6:return[7];case 7:return[2]}})})},t.prototype._clearResetRequestTimeout=function(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)},t.prototype._failOnErrorsCount=function(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))},t.prototype._makeNextRequest=function(){return x.b(this,void 0,void 0,function(){var t=this;return x.d(this,function(e){return this._requestTimeOut=null,this._requestTimeOut=setTimeout(function(){return x.b(t,void 0,void 0,function(){return x.d(this,function(t){switch(t.label){case 0:return[4,this._request()];case 1:return t.sent(),[2]}})})},this._requestInterval),[2]})})},t}(),X=function(){function t(t,e,r,s,i,o,n){this.update=new G.a,this.statusChanged=new G.a,this._data=[],this._status=0,this._requester=new K(t,e,r,s,n),this._idField=i,this._keys=o}return t.prototype.start=function(){this._status=1,this._requester.update.subscribe(this,this._onNewData),this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()},t.prototype.stop=function(){this._status=0,this._requester.update.unsubscribe(this,this._onNewData),this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester},t.prototype._onNewData=function(t,e){if(1===this._status){var r=Object(N.findArraysDifferences)(this._data,t,this._idField,this._keys);(r.added.length>0||r.modified.length>0||r.removed.length>0)&&(this._data=t,this.update.fire(r,e))}},t.prototype._onStatusChanged=function(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})},t}(),r.d(e,"Broker",function(){return ot}),Z={limit:1,market:2,stop:3,stoplimit:4},Y={},Y[1]="limit",Y[2]="market",Y[3]="stop",Y[4]="stoplimit",tt=Y,et={pending:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},rt=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId"],st=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","takeProfit"],it={
checked:!1,text:""},ot=function(){function t(t,e,r,s){var i,o;void 0===s&&(s=null),i=this,this._accountType=1,this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._requesters={},this._depthSubscriptions={},this._host=t,this._restUrl=c(e),this._metainfo=r,this._realtimeSubscriptions=new Set,this._initData(),this._tokenStorageKey="rest-token-"+r.id,this._logger=t.getLogger(),this._mapper=t.createMapper(Object(V.ensure)(r.id)),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[]}),this._summaryValues={balance:t.factory.createWatchedValue(),equity:t.factory.createWatchedValue(),unrealizedPl:t.factory.createWatchedValue()},this._setAccountBinded=this._setAccount.bind(this),s&&(o=new Date,o.setDate(o.getDate()+5),this._saveAccessToken({access_token:s,expiration:o.valueOf()})),this._createButtonDropdownOptions(),this._host.floatingTradingPanelVisibility().subscribe(function(){i._createButtonDropdownOptions()}),this._host.domVisibility().subscribe(function(){i._createButtonDropdownOptions()}),setTimeout(function(){return i._tryConnect()},0)}return t.prototype.chartContextMenuActions=function(t,e){return this._host.defaultContextMenuActions(t,e)},t.prototype.accountInfo=function(){return Promise.resolve(this._account.value())},t.prototype.accountManagerInfo=function(){var t,e,r,s=this,i=[{text:$.t("Account Balance"),wValue:this._summaryValues.balance},{text:$.t("Equity",{context:"trading"}),wValue:this._summaryValues.equity},{text:$.t("Profit"),wValue:this._summaryValues.unrealizedPl}],o=this._account.value().config.supportOrderBrackets||this._account.value().config.supportPositionBrackets,n=[];return q(this._brokerConfig)&&(n=Object(V.ensure)(this._brokerConfig.accountManager).map(function(t,e){return Object.assign({},{id:t.id,title:t.title,getData:function(){return Promise.resolve(s._accountManagerTablesData[e])},changeDelegate:s._accountManagerTablesDelegates[e],columns:t.columns.map(function(t){return Object.assign({},{id:t.id,label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,notSortable:!t.sortable,fixedWidth:t.fixedWidth})})})})),t=function(t){return o||"stopLoss"!==t.property&&"takeProfit"!==t.property},e=function(t){return s._brokerConfig.durations||"expiry"!==t.property},r={accountTitle:Object(V.ensure)(this._metainfo.title),account:this._account,accountsList:this._accounts,orderColumns:R.filter(t).filter(e),pages:[{id:"summary",title:$.t("Account Summary"),tables:n}],positionColumns:E.filter(t),summary:i,customFormatters:[]},this._account.value().config.supportOrdersHistory&&(r.historyColumns=C.filter(t)),r},t.prototype.currentAccount=function(){return this._account.value().name},t.prototype.currentAccountType=function(){return 1===this._accountType?"demo":"real"},t.prototype.executions=function(t){return Promise.resolve(this._tvExecutions.filter(function(e){return e.symbol===t}))},t.prototype.orders=function(){return Promise.resolve(this._tvOrders)},
t.prototype.positions=function(){return Promise.resolve(this._tvPositions)},t.prototype.cancelOrder=function(t,e){return x.b(this,void 0,void 0,function(){var r,s=this;return x.d(this,function(i){return r=this._getOrderIdRestUrl(t),e?[2,u(r,this._getAccessToken(),F.Delete)]:[2,this._host.showCancelOrderDialog(t,function(){return f(n(r,s._getAccessToken(),F.Delete))})]})})},t.prototype.modifyOrder=function(t,e,r){return x.b(this,void 0,void 0,function(){var s,i,o,n,a,u,c=this;return x.d(this,function(l){return s=this._account.value().config.supportDigitalSignature,2===t.parentType?void 0===this._tvPositionById(t.parentId)?[2]:(i=this._getPositionBracketsById(t.parentId),[2,this.editPositionBrackets(Object(V.ensure)(t.brokerSymbol),1===t.type?3:1,{takeProfit:t.limitPrice||i.takeProfit,stopLoss:t.stopPrice||i.stopLoss},e)]):1===t.parentType?(o=this._tvOrderById(Object(V.ensure)(t.parentId)),[2,this.modifyOrder(x.a({},o,{stopLoss:t.stopPrice,takeProfit:t.limitPrice}),e,t.stopPrice?1:3)]):e?(n=s?g().text:null,[2,this._modifyOrder(t,n)]):(i=this._getOrderBrackets(t.id),a=Object.assign({},t),a.stopLoss=t.stopLoss?t.stopLoss:i.stopLoss,a.takeProfit=t.takeProfit?t.takeProfit:i.takeProfit,u=s?m():void 0,[2,this._host.showOrderDialog(a,function(t,e){var r=null;return void 0!==e&&(r=e.digitalSignature.text,y(e.digitalSignature)),c._modifyOrder(t,r)},r,u)])})})},t.prototype.placeOrder=function(t,e){return x.b(this,void 0,void 0,function(){var r,s,i,o,n,a,u,c=this;return x.d(this,function(l){switch(l.label){case 0:return[4,this.isTradable(t.symbol)];case 1:return r=l.sent(),s=this._account.value().config.supportDigitalSignature,r?e?(i=s?g().text:null,[2,this._placeOrder(t,i)]):(o=s?m():void 0,[2,this._host.showOrderDialog(t,function(t,e){var r=null;return void 0!==e&&(r=e.digitalSignature.text,y(e.digitalSignature)),c._placeOrder(t,r)},void 0,o)]):[3,2];case 2:n=void 0,a=null,l.label=3;case 3:return l.trys.push([3,5,,6]),[4,this._mapFromTV(t.symbol)];case 4:return n=l.sent(),a=this._getAccountWithTradableSymbol(n),[3,6];case 5:return u=l.sent(),this._logger.logWarn("Cannot map symbol: "+t.symbol),[3,6];case 6:d(Object(V.ensure)(this._metainfo.title),a),l.label=7;case 7:return[2]}})})},t.prototype.cancelOrders=function(t,e,r,s){return x.b(this,void 0,void 0,function(){var i,o=this;return x.d(this,function(n){return i=function(){return Promise.all(r.map(function(t){return o.cancelOrder(t,!0)})).then(function(){})},s?[2,i()]:[2,this._host.showCancelMultipleOrdersDialog(t,e,r.length,i)]})})},t.prototype.editPositionBrackets=function(t,e,r,s){var i,o,n,a,u=this;return s?this._editPositionBrackets(t,r):(i=Object(V.ensure)(this._tvPositionById(t)),o=this._getPositionBracketsById(t),n=r&&r.stopLoss?r.stopLoss:o.stopLoss,a=r&&r.takeProfit?r.takeProfit:o.takeProfit,this._host.showPositionBracketsDialog(i,{stopLoss:n,takeProfit:a},e||null,function(e){return u._editPositionBrackets(t,e)}))},t.prototype.closePosition=function(t,e){var r=this;return e?this._closePosition(t):this._host.showClosePositionDialog(t,function(){
return r._closePosition(t)})},t.prototype.isTradable=function(t){return x.b(this,void 0,void 0,function(){var e,r;return x.d(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,this._mapFromTV(t)];case 1:return e=s.sent(),[2,-1!==this._instruments.findIndex(function(t){return t.name===e})];case 2:return r=s.sent(),[2,!1];case 3:return[2]}})})},t.prototype.subscribeRealtime=function(t){return x.b(this,void 0,void 0,function(){var e,r;return x.d(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,this._mapFromTV(t)];case 1:return e=s.sent(),this._realtimeSubscriptions.add(e),[3,3];case 2:return r=s.sent(),this._logger.logError(h(r)),[2];case 3:return this._changeQuotesRequesterUrl(),[2]}})})},t.prototype.unsubscribeRealtime=function(t){return x.b(this,void 0,void 0,function(){var e,r;return x.d(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,this._mapFromTV(t)];case 1:return e=s.sent(),this._realtimeSubscriptions.delete(e)&&this._changeQuotesRequesterUrl(),[3,3];case 2:return r=s.sent(),this._logger.logError(h(r)),[3,3];case 3:return[2]}})})},t.prototype.subscribeDOME=function(t){return x.b(this,void 0,void 0,function(){var e,r,s,i,o;return x.d(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._mapFromTV(t)];case 1:return e=n.sent(),r=this._getDepthUrl(e),s=new K(r,F.Get,this._getHeaders(),this._getPullingInterval("quotes"),b),i=this._onDepthUpdate.bind(this,t),s.update.subscribe(this,i),s.start(),this._depthSubscriptions[t]={callback:i,requester:s},[3,3];case 2:return o=n.sent(),this._logger.logError(h(o)),[2];case 3:return[2]}})})},t.prototype.unsubscribeDOME=function(t){try{this._depthSubscriptions[t].requester.update.unsubscribe(this,this._depthSubscriptions[t].callback),this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){this._logger.logError(h(t))}},t.prototype.signIn=function(t,e,r){return x.b(this,void 0,void 0,function(){var r,s,i,o;return x.d(this,function(n){switch(n.label){case 0:this._setStatus(2),n.label=1;case 1:return n.trys.push([1,5,,6]),localStorage.removeItem(this._tokenStorageKey),[4,this._authorize(t,e)];case 2:return r=n.sent(),this._saveAccessToken(r),s=this,[4,this._getBrokerConfig()];case 3:return s._brokerConfig=n.sent(),[4,this._initializeAccount()];case 4:return n.sent(),this._createButtonDropdownOptions(),[3,6];case 5:return i=n.sent(),o=h(i),this._logger.logError("Failed to connect to broker: "+o),this.disconnect(),this._setStatus(4,h(i)),[3,6];case 6:return[2]}})})},t.prototype.symbolInfo=function(t){return x.b(this,void 0,void 0,function(){var e,r,s;return x.d(this,function(i){switch(i.label){case 0:return[4,this._mapFromTV(t)];case 1:return e=i.sent(),(r=this._instruments.find(function(t){return t.name===e}))?(s={qty:{min:r.minQty||1,max:r.maxQty||1e9,step:r.qtyStep||1},pipValue:r.pipValue||1,pipSize:r.pipSize||.01,minTick:r.minTick||.01,description:r.description},r.hasOwnProperty("lotSize")&&(s.lotSize=r.lotSize),
[2,Promise.resolve(s)]):[2,Promise.reject("Instrument not found")]}})})},t.prototype.connectionStatus=function(){return this._status.value()},t.prototype.disconnect=function(){this._disconnect()},t.prototype.supportFloatingPanel=function(){return!0},t.prototype.getRealtimeDataCheckParams=function(){return{token:this._getAccessToken()}},t.prototype._disconnect=function(t){this._setStatus(3,t),this._cleanup(),localStorage.removeItem(this._tokenStorageKey),this._account.unsubscribe(this._setAccountBinded)},t.prototype._getAccessToken=function(){return this._accessToken},t.prototype._initializeAccount=function(){return x.b(this,void 0,void 0,function(){var t,e,r,s,i;return x.d(this,function(o){switch(o.label){case 0:return t=this,[4,this._getAccounts()];case 1:t._accounts=o.sent(),Object(V.assert)(!!this._accounts.length),e=0,r=this._accounts,o.label=2;case 2:return e<r.length?(s=r[e],i=s,[4,this._getInstrumentsByAccountId(s.id)]):[3,5];case 3:i.instruments=o.sent(),o.label=4;case 4:return e++,[3,2];case 5:return[4,this._setAccount(this._accounts[0])];case 6:return o.sent(),this._account.subscribe(this._setAccountBinded),[2]}})})},t.prototype._onQuotesUpdate=function(t){return x.b(this,void 0,void 0,function(){var e,r,s,i,o;return x.d(this,function(n){switch(n.label){case 0:e=0,r=t,n.label=1;case 1:if(!(e<r.length))return[3,6];if(s=r[e],"ok"!==s.s)return[3,5];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this._mapToTV(s.n)];case 3:return i=n.sent(),s.v.lp=s.v.lp||0,s.v.ch=s.v.ch||0,s.v.chp=s.v.chp||0,this._host.realtimeUpdate(i,s.v),[3,5];case 4:return o=n.sent(),this._logger.logError(h(o)),[2];case 5:return e++,[3,1];case 6:return[2]}})})},t.prototype._changeQuotesRequesterUrl=function(){var t=this._getQuotesUrl();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new K(t,F.Get,this._getHeaders(),this._getPullingInterval("quotes"),b),this._requesters.quotes.update.subscribe(this,this._onQuotesUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())},t.prototype._closePosition=function(t){return u(this._getPositionIdRestUrl(t),this._getAccessToken(),F.Delete)},t.prototype._stopRequester=function(t){void 0!==t&&(t.stop(),t.update.unsubscribeAll(this))},t.prototype._setAccount=function(t){return x.b(this,void 0,void 0,function(){var e,r,s;return x.d(this,function(i){switch(i.label){case 0:return this._cleanup(),1===this.connectionStatus()&&this._setStatus(2),this._account.setValue(t),[4,this._initRequesters()];case 1:return i.sent(),this._instruments=t.instruments,[4,this._getAccountState()];case 2:for(e=i.sent(),r=0;r<Object(V.ensure)(this._brokerConfig.accountManager).length;r++)s=this._host.factory.createDelegate(),this._accountManagerTablesDelegates.push(s),this._accountManagerTablesData.push([{}]);return this._setAccountManagerTableData(I(e)),this._setSummaryValues(e),this._host.patchConfig(t.config),this._brokerConfig.durations&&this._host.setDurations(A(this._brokerConfig.durations)),this._setStatus(1),[2]}})
})},t.prototype._requestExecutions=function(t){return x.b(this,void 0,void 0,function(){var e,r,s,i,o,n;return x.d(this,function(a){switch(a.label){case 0:return[4,_(this._getExecutionsUrl(t),F.Get,this._getHeaders(),b)];case 1:e=a.sent(),r=Object(N.findArraysDifferences)(this._restExecutions,e,"id",["id"]),s=0,i=r.added,a.label=2;case 2:return s<i.length?(o=i[s],this._restExecutions.push(o),[4,this._executionToTv(o)]):[3,5];case 3:n=a.sent(),this._tvExecutions.push(n),this._host.executionUpdate(n),a.label=4;case 4:return s++,[3,2];case 5:return[2]}})})},t.prototype._updateExecutionsBySymbols=function(t){return x.b(this,void 0,void 0,function(){var e=this;return x.d(this,function(r){return Promise.all(t.map(function(t){return e._requestExecutions(t)})),[2]})})},t.prototype._setSummaryValues=function(t){var e=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;this._summaryValues.balance.setValue(t.balance),this._summaryValues.equity.setValue(e),this._host.equityUpdate(e),this._summaryValues.unrealizedPl.setValue(t.unrealizedPl)},t.prototype._setAccountManagerTableData=function(t){var e,r,s,i,o,n,a,u,c;if(0!==this._accountManagerTablesData.length)for(e=0;e<t.length;e++)for(r=t[e],s=this._accountManagerTablesData[e],i=Object(V.ensure)(this._brokerConfig.accountManager)[e].columns,s.length=r.length,o=0;o<r.length;o++){for(n=r[o],a={id:o},u=0;u<n.length;u++)c=Object(V.ensure)(i[u].id),a[c]=n[u];s[o]=a,this._accountManagerTablesDelegates[e].fire(a)}},t.prototype._createRequesters=function(){return x.b(this,void 0,void 0,function(){var t,e,r,s,i;return x.d(this,function(o){return t=this._getOrdersRestUrl(),e=this._getPositionsRestUrl(),r=this._getAccountStateRestUrl(),this._requesters={positions:new X(e,F.Get,this._getHeaders(),this._getPullingInterval("positions"),"id",st,b),orders:new X(t,F.Get,this._getHeaders(),this._getPullingInterval("orders"),"id",rt,b),accountState:new K(r,F.Get,this._getHeaders(),this._getPullingInterval("accountManager"),b)},s=Object(V.ensure)(this._requesters.positions),s.update.subscribe(this,this._onPositionsUpdate),s.statusChanged.subscribe(this,this._onRequesterStatusUpdate),i=Object(V.ensure)(this._requesters.orders),i.update.subscribe(this,this._onOrdersUpdate),i.statusChanged.subscribe(this,this._onRequesterStatusUpdate),Object(V.ensure)(this._requesters.accountState).update.subscribe(this,this._onAccountStateUpdate),[2]})})},t.prototype._startRequesters=function(){var t=this;Object.keys(this._requesters).forEach(function(e){return Object(V.ensure)(t._requesters[e]).start()})},t.prototype._stopAndDeleteRequesters=function(){var t=this;Object.keys(this._requesters).forEach(function(e){var r=t._requesters[e];void 0!==r&&t._stopRequester(r)}),this._requesters={}},t.prototype._cleanup=function(){this._stopAndDeleteRequesters(),this._initData()},t.prototype._setStatus=function(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))},t.prototype._onRequesterStatusUpdate=function(t){
2===t.requesterStatus&&this._disconnect(t.errorMessage)},t.prototype._onAccountStateUpdate=function(t){return x.b(this,void 0,void 0,function(){var e;return x.d(this,function(r){return this._setSummaryValues(t),e=I(t),this._setAccountManagerTableData(e),[2]})})},t.prototype._tryConnect=function(){return x.b(this,void 0,void 0,function(){var t,e,r;return x.d(this,function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(t=this._getStoredAuthResult())?(this._accessToken=t.access_token,this._setStatus(2),e=this,[4,this._getBrokerConfig()]):[3,3];case 1:return e._brokerConfig=s.sent(),[4,this._initializeAccount()];case 2:s.sent(),this._setAccessTokenExpirationTimeout(t),this._createButtonDropdownOptions(),s.label=3;case 3:return[3,5];case 4:return r=s.sent(),this.disconnect(),this._logger.logError(h(r)),[3,5];case 5:return[2]}})})},t.prototype._authorize=function(t,e){return x.b(this,void 0,void 0,function(){var r;return x.d(this,function(s){return r=this._getAuthorizeUrl(),[2,l(r,t,e)]})})},t.prototype._getAccounts=function(){return x.b(this,void 0,void 0,function(){var t,e,r,s;return x.d(this,function(i){switch(i.label){case 0:return[4,u(this._getAccountsUrl(),this._getAccessToken())];case 1:for(t=i.sent(),e=0,r=t;e<r.length;e++)s=r[e],s.currency=s.currency||"",s.currencySign=s.currencySign||"";return[2,t]}})})},t.prototype._getInstrumentsByAccountId=function(t){return x.b(this,void 0,void 0,function(){return x.d(this,function(e){return[2,u(this._getInstrumentsUrlByAccountId(t),this._getAccessToken())]})})},t.prototype._getBrokerConfig=function(){return x.b(this,void 0,void 0,function(){var t;return x.d(this,function(e){switch(e.label){case 0:return[4,u(this._getBrokerConfigUrl(),this._getAccessToken())];case 1:return t=e.sent(),q(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:window.t("Balance"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"equity",title:window.t("Equity"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"totalProfit",title:window.t("Profit"),tooltip:"",formatter:"profit",fixedWidth:!0,sortable:!1}]}]),[2,t]}})})},t.prototype._getAccountState=function(){return x.b(this,void 0,void 0,function(){return x.d(this,function(t){return[2,u(this._getAccountStateUrl(),this._getAccessToken())]})})},t.prototype._placeOrder=function(t,e){return x.b(this,void 0,void 0,function(){var r,s;return x.d(this,function(i){switch(i.label){case 0:return[4,this._orderFromTV(t)];case 1:return r=i.sent(),s=this._getOrdersRestUrl()+S(),null!==e&&(r.digitalSignature=e),[2,u(s,this._getAccessToken(),F.Post,r)]}})})},t.prototype._modifyOrder=function(t,e){return x.b(this,void 0,void 0,function(){var r,s;return x.d(this,function(i){return r={id:t.id,qty:t.qty},t.parent||(t.stopLoss&&(r.stopLoss=t.stopLoss),t.takeProfit&&(r.takeProfit=t.takeProfit)),r.limitPrice=(t.type,t.limitPrice),r.stopPrice=(t.type,t.stopPrice),s=this._getOrderIdRestUrl(t.id),null!==e&&(r.digitalSignature=e),[2,u(s,this._getAccessToken(),F.Put,r)]})})},t.prototype._createTvOrders=function(t){var e=this
;return Promise.all(t.map(function(t){return e._orderToTV(t)}))},t.prototype._onOrdersUpdate=function(t,e){return x.b(this,void 0,void 0,function(){var r,s,i,o,n,a,u,c,l,h,d,p=this;return x.d(this,function(_){switch(_.label){case 0:return[4,this._createTvOrders(t.added)];case 1:return i=_.sent(),[4,this._createTvOrders(t.modified)];case 2:for(o=_.sent(),n=[],(r=this._restOrders).push.apply(r,t.added),a=0,u=t.modified;a<u.length;a++)c=u[a],this._restOrders[this._restOrderIndexById(c.id)]=c;for((s=this._tvOrders).push.apply(s,i),n.push.apply(n,i),l=0,h=o;l<h.length;l++)d=h[l],this._tvOrders[this._tvOrderIndexById(d.id)]=d,n.push(d);return n.forEach(function(t){var r,s,i,o,n;1===t.parentType?(r=p._tvOrderById(t.parentId))&&(U(r,t),p._host.orderUpdate(r,e)):2===t.parentType?(s=p._tvPositionById(t.symbol))&&s.qty>0&&(U(s,t),i=s.stopLoss,o=s.takeProfit,p._host.positionPartialUpdate(s.id,{stopLoss:i,takeProfit:o})):t.parentType||(n=p._getOrderBrackets(t.id),n.stopLoss&&(t.stopLoss=n.stopLoss),n.takeProfit&&(t.takeProfit=n.takeProfit)),p._host.orderUpdate(t,e)}),[2]}})})},t.prototype._createTVPositions=function(t){var e=this;return Promise.all(t.map(function(t){return e._positionToTV(t)}))},t.prototype._onPositionsUpdate=function(t){return x.b(this,void 0,void 0,function(){var e,r,s,i,o,n,a,u,c,l,h,d,p,_,f,y,g=this;return x.d(this,function(m){switch(m.label){case 0:return e=[],[4,this._createTVPositions(t.added)];case 1:return r=m.sent(),[4,this._createTVPositions(t.modified)];case 2:for(s=m.sent(),i=0,o=t.added;i<o.length;i++)n=o[i],this._addOrModifyPosition(n,this._restPositions);for(a=0,u=t.modified;a<u.length;a++)n=u[a],this._restPositions[this._restPositionIndexById(n.id)]=n;for(c=function(t){l._addOrModifyPosition(t,l._tvPositions),l._findPositionBracketOrders(t.id).forEach(function(e){return U(t,e)}),l._host.positionUpdate(t),l._host.plUpdate(t.id,t.unrealizedPl),e.push(t.id)},l=this,h=0,d=r;h<d.length;h++)p=d[h],c(p);for(_=0,f=s;_<f.length;_++){if(p=f[_],void 0===(y=this._tvPositionById(p.id)))return[2];this._host.positionUpdate(p),y.unrealizedPl!==p.unrealizedPl&&(this._host.plUpdate(p.id,p.unrealizedPl),this._host.positionPartialUpdate(p.id,{unrealizedPl:p.unrealizedPl})),y.side===p.side&&y.qty===p.qty||e.push(p.id),this._addOrModifyPosition(p,this._tvPositions)}return t.removed.forEach(function(t){var e,r=g._tvPositionById(t.id);void 0!==r&&(e=g._restPositionById(t.id),r.qty=0,e.qty=0,g._host.positionUpdate(r))}),this._updateExecutionsBySymbols(e),[2]}})})},t.prototype._addOrModifyPosition=function(t,e){var r=e.findIndex(function(e){return e.id===t.id});-1!==r?e[r]=t:e.push(t)},t.prototype._restPositionIndexById=function(t){return this._restPositions.findIndex(function(e){return e.id===t})},t.prototype._restPositionById=function(t){var e=this._restPositions.find(function(e){return e.id===t});if(!e)throw Error("Cannot find REST position: "+t);return e},t.prototype._restOrderIndexById=function(t){return this._restOrders.findIndex(function(e){return e.id===t})},t.prototype._tvPositionById=function(t){
return this._tvPositions.find(function(e){return e.id===t})},t.prototype._tvOrderIndexById=function(t){return this._tvOrders.findIndex(function(e){return e.id===t})},t.prototype._tvOrderById=function(t){var e=this._tvOrders.find(function(e){return e.id===t});if(!e)throw Error("Cannot find TV order");return e},t.prototype._getBaseRestUrl=function(){var t=this._account.value().id;return Object(V.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)},t.prototype._getBaseRestUrlByAccountId=function(t){return this._restUrl+"accounts/"+t},t.prototype._getAccountStateRestUrl=function(){return this._getBaseRestUrl()+"/state?locale="+window.locale},t.prototype._getExecutionsUrl=function(t){return this._getBaseRestUrl()+"/executions?instrument="+encodeURIComponent(t)},t.prototype._getPullingInterval=function(t){var e,r=500;return this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval&&(e=this._brokerConfig.pullingInterval,e.hasOwnProperty(t)&&(r=e[t])),r},t.prototype._getAuthorizeUrl=function(){return this._restUrl+"authorize"},t.prototype._getBrokerConfigUrl=function(){return this._restUrl+"config?locale="+window.locale},t.prototype._getAccountsUrl=function(){return this._restUrl+"accounts"},t.prototype._getAccountStateUrl=function(){return this._getBaseRestUrl()+"/state?locale="+window.locale},t.prototype._getQuotesUrl=function(){var t,e=Array.from(this._realtimeSubscriptions);return 0===e.length?null:(t=e.join(","),this._restUrl+"quotes?symbols="+encodeURIComponent(t))},t.prototype._getDepthUrl=function(t){return this._restUrl+"depth?symbol="+encodeURIComponent(t)},t.prototype._getInstrumentsUrlByAccountId=function(t){return this._getBaseRestUrlByAccountId(t)+"/instruments/"},t.prototype._getOrdersRestUrl=function(){return this._getBaseRestUrl()+"/orders/"},t.prototype._getOrderIdRestUrl=function(t){return this._getBaseRestUrl()+"/orders/"+t},t.prototype._getPositionsRestUrl=function(){return this._getBaseRestUrl()+"/positions/"},t.prototype._getPositionIdRestUrl=function(t){return this._getBaseRestUrl()+"/positions/"+t},t.prototype._getHeaders=function(){return i(this._getAccessToken())},t.prototype._orderToTV=function(t){return x.b(this,void 0,void 0,function(){var e,r,s,i;return x.d(this,function(o){switch(o.label){case 0:e=t.instrument,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this._mapToTV(t.instrument)];case 2:return e=o.sent(),[3,4];case 3:return r=o.sent(),this._logger.logWarn("Cannot map symbol: "+t.instrument),[3,4];case 4:return s={id:t.id,type:v(t.type),side:w(t.side),symbol:e,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:T(t.status),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice},t.parentId&&(s.parentId=t.parentId,s.parentType="position"===t.parentType?2:1),t.stopLoss&&(s.stopLoss=t.stopLoss),t.takeProfit&&(s.takeProfit=t.takeProfit),t.duration&&t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime&&(i=1e3*t.duration.datetime,s.duration={
type:t.duration.type,datetime:i},s.expiry=i),[2,s]}})})},t.prototype._orderFromTV=function(t){return x.b(this,void 0,void 0,function(){var e,r;return x.d(this,function(s){switch(s.label){case 0:return[4,this._mapFromTV(t.symbol)];case 1:return e=s.sent(),r={brokerSymbol:e,instrument:e,qty:t.qty,side:k(t.side),type:P(t.type),limitPrice:t.limitPrice,stopPrice:t.stopPrice},t.stopLoss&&(r.stopLoss=t.stopLoss),t.takeProfit&&(r.takeProfit=t.takeProfit),t.duration&&(r.durationType=t.duration.type,t.duration.datetime&&(r.durationDateTime=t.duration.datetime/1e3)),[2,r]}})})},t.prototype._getOrderBrackets=function(t){var e,r,s,i=this._tvOrders.filter(function(e){return 1===e.parentType&&e.parentId===t&&1!==e.status}),o={};for(e=0,r=i;e<r.length;e++)s=r[e],3===s.type&&(o.stopLoss=s.stopPrice),1===s.type&&(o.takeProfit=s.limitPrice);return o},t.prototype._findPositionBracketOrders=function(t){return this._tvOrders.filter(function(e){return 2===e.parentType&&e.parentId===t&&6===e.status})},t.prototype._getPositionBracketsById=function(t){var e,r,s,i=this._findPositionBracketOrders(t),o={};for(e=0,r=i;e<r.length;e++)s=r[e],3===s.type&&(o.stopLoss=s.stopPrice),1===s.type&&(o.takeProfit=s.limitPrice);return o},t.prototype._editPositionBrackets=function(t,e){var r=this._getPositionIdRestUrl(t),s=Object.assign({},e);return u(r,this._getAccessToken(),F.Put,s)},t.prototype._executionToTv=function(t){return x.b(this,void 0,void 0,function(){var e,r;return x.d(this,function(s){switch(s.label){case 0:e="",s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this._mapToTV(t.instrument)];case 2:return e=s.sent(),[3,4];case 3:return r=s.sent(),this._logger.logWarn("Cannot map symbol: "+t.instrument),[3,4];case 4:return[2,{id:t.id,symbol:e,brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:w(t.side),time:t.time}]}})})},t.prototype._positionToTV=function(t){return x.b(this,void 0,void 0,function(){var e,r,s;return x.d(this,function(i){switch(i.label){case 0:e=t.instrument,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this._mapToTV(t.instrument)];case 2:return e=i.sent(),[3,4];case 3:return r=i.sent(),this._logger.logWarn("Cannot map symbol: "+t.instrument),[3,4];case 4:return s={id:t.id,symbol:e,brokerSymbol:t.instrument,qty:t.qty,side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,unrealizedPl:t.unrealizedPl,realizedPl:t.realizedPl},this._tvOrders.filter(function(t){return 2===t.parentType&&t.symbol===s.symbol}).forEach(function(t){return U(s,t)}),[2,s]}})})},t.prototype._mapToTV=function(t){return this._mapper.brokerToTv(t)},t.prototype._mapFromTV=function(t){return this._mapper.tvToBroker(t)},t.prototype._initData=function(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._realtimeSubscriptions.clear(),this._instruments=[]},t.prototype._createButtonDropdownOptions=function(){var t,e={showFloatingToolbar:!0,showDOM:!0,tradingProperties:!0,selectAnotherBroker:!0,disconnect:!0}
;e.disconnect=!1,e.selectAnotherBroker=!1,t=this._host.defaultDropdownMenuActions(e),this._host.setButtonDropdownActions(t)},t.prototype._initRequesters=function(){return x.b(this,void 0,void 0,function(){return x.d(this,function(t){switch(t.label){case 0:return this._accounts.length>0?[4,this._createRequesters()]:[3,2];case 1:t.sent(),this._startRequesters(),t.label=2;case 2:return[2]}})})},t.prototype._getStoredAuthResult=function(){var t=localStorage.getItem(this._tokenStorageKey);return t?JSON.parse(t):null},t.prototype._setAccessTokenExpirationTimeout=function(t){var e=1e3*t.expiration-Date.now().valueOf();e<0?this._checkAccessTokenExpiration():setTimeout(this._checkAccessTokenExpiration.bind(this),e+1e4)},t.prototype._saveAccessToken=function(t){localStorage.setItem(this._tokenStorageKey,JSON.stringify(t)),this._setAccessTokenExpirationTimeout(t),this._accessToken=t.access_token},t.prototype._checkAccessTokenExpiration=function(){var t,e=this._getStoredAuthResult();e&&1e3*e.expiration<=Date.now().valueOf()&&(t="Access token has expired",this._logger.logError(t),this._disconnect(t))},t.prototype._onDepthUpdate=function(t,e){var r={snapshot:!0,asks:B(e.asks),bids:B(e.bids)};this._host.domeUpdate(t,r)},t.prototype._getAccountWithTradableSymbol=function(t){var e,r,s,i=null;for(e=0,r=this._accounts;e<r.length;e++)if(s=r[e],-1!==s.instruments.findIndex(function(e){return t===e.name})){i=s.name;break}return i},t}()}});